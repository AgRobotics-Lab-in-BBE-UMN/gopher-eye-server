#!/bin/bash

# Load environment variables
DB_HOST=${DB_HOST:-"localhost"}
DB_PORT=${DB_PORT:-"5432"}
DB_NAME=${DB_NAME:-"default_db"}
DB_USER=${DB_USER:-"postgres"}
DB_PASSWORD=${DB_PASSWORD:-""}

# Check if required environment variables are set
if [[ -z "$DB_HOST" || -z "$DB_PORT" || -z "$DB_NAME" || -z "$DB_USER" || -z "$DB_PASSWORD" ]]; then
  echo "Error: Missing required environment variables."
  echo "Ensure DB_HOST, DB_PORT, DB_NAME, DB_USER, and DB_PASSWORD are set."
  exit 1
fi

# Export the password for psql
export PGPASSWORD=$DB_PASSWORD

# Create the database
echo "Creating database '$DB_NAME' on host '$DB_HOST' with user '$DB_USER'..."
psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -c "CREATE DATABASE \"$DB_NAME\";" 2>/dev/null

if [[ $? -eq 0 ]]; then
  echo "Database '$DB_NAME' created successfully."
else
  echo "Error: Failed to create database '$DB_NAME'. It may already exist or there was a connection issue."
fi

# Apply the schema from create_db.sql
echo "Applying schema from create_db.sql..."
psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f ./script/sql/create_db.sql

if [[ $? -eq 0 ]]; then
  echo "Schema applied successfully."
else
  echo "Error: Failed to apply schema to database '$DB_NAME'."
fi

# Unset the password for security
unset PGPASSWORD
